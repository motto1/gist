name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type (auto|patch|minor|major)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
  push:
    branches:
      - main
      - master

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release-windows:
    if: ${{ github.event_name != 'push' || !contains(github.event.head_commit.message || '', '[skip ci]') }}
    runs-on: windows-latest
    timeout-minutes: 150

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NODE_OPTIONS: --max-old-space-size=8192

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install corepack
        run: corepack enable && corepack prepare yarn@4.6.0 --activate

      - name: Resolve release version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          INPUT_BUMP="${{ github.event.inputs.bump }}"
          if [ -z "${INPUT_BUMP}" ]; then
            INPUT_BUMP="auto"
          fi

          LAST_TAG=$(git tag --list "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n1 || true)
          if [ -n "${LAST_TAG}" ]; then
            BASE_VERSION="${LAST_TAG#v}"
            RANGE="${LAST_TAG}..HEAD"
          else
            BASE_VERSION=$(node -p "require('./package.json').version")
            RANGE="HEAD"
          fi

          COMMIT_MESSAGES=$(git log --format=%B ${RANGE} || true)

          BUMP="${INPUT_BUMP}"
          if [ "${BUMP}" = "auto" ]; then
            BUMP="patch"
            if printf "%s\n" "${COMMIT_MESSAGES}" | grep -Eqi 'BREAKING CHANGE|^[a-z]+(\([^)]+\))?!:'; then
              BUMP="major"
            elif printf "%s\n" "${COMMIT_MESSAGES}" | grep -Eq '^feat(\([^)]+\))?:'; then
              BUMP="minor"
            fi
          fi

          NEXT_VERSION=$(BASE_VERSION="${BASE_VERSION}" BUMP="${BUMP}" node <<'NODE'
          const base = process.env.BASE_VERSION || '0.0.0'
          const bump = process.env.BUMP || 'patch'
          const [major0, minor0, patch0] = base
            .split('-')[0]
            .split('.')
            .map((x) => Number.parseInt(x, 10))

          let major = Number.isFinite(major0) ? major0 : 0
          let minor = Number.isFinite(minor0) ? minor0 : 0
          let patch = Number.isFinite(patch0) ? patch0 : 0

          if (bump === 'major') {
            major += 1
            minor = 0
            patch = 0
          } else if (bump === 'minor') {
            minor += 1
            patch = 0
          } else {
            patch += 1
          }

          process.stdout.write(`${major}.${minor}.${patch}`)
          NODE
          )

          echo "base=${BASE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "bump=${BUMP}" >> "$GITHUB_OUTPUT"
          echo "version=${NEXT_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${NEXT_VERSION}" >> "$GITHUB_OUTPUT"

          echo "Resolved release: base=${BASE_VERSION}, bump=${BUMP}, next=${NEXT_VERSION}"

      - name: Set package.json version
        shell: bash
        run: |
          npm version "${{ steps.version.outputs.version }}" --no-git-tag-version --allow-same-version

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        shell: bash
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache yarn dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.yarn-cache-dir-path.outputs.dir }}
            node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install Dependencies
        run: yarn install

      - name: Build app bundles
        run: yarn build

      - name: Package Pro edition (with voice)
        shell: pwsh
        run: |
          $outDir = Join-Path $env:RUNNER_TEMP "release-pro"
          Remove-Item -Recurse -Force -Path $outDir -ErrorAction SilentlyContinue

          $env:APP_EDITION = "pro"
          $env:BUILD_VOICE = "full"
          Remove-Item Env:BUILD_SUFFIX -ErrorAction SilentlyContinue
          yarn run electron-builder --win --x64 --publish never --config.directories.output="$outDir"

      - name: Package Basic edition (no voice)
        shell: pwsh
        run: |
          $outDir = Join-Path $env:RUNNER_TEMP "release-basic"
          Remove-Item -Recurse -Force -Path $outDir -ErrorAction SilentlyContinue

          $env:APP_EDITION = "basic"
          $env:BUILD_VOICE = "none"
          Remove-Item Env:BUILD_SUFFIX -ErrorAction SilentlyContinue
          yarn run electron-builder --win --x64 --publish never --config.directories.output="$outDir"

      - name: Collect Pro & Basic installers
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null

          $proSetup = Join-Path (Join-Path $env:RUNNER_TEMP "release-pro") "gist-$version-x64-setup.exe"
          $basicSetup = Join-Path (Join-Path $env:RUNNER_TEMP "release-basic") "gist-$version-x64-setup.exe"

          if (-not (Test-Path $proSetup)) {
            throw "Pro installer not found: $proSetup"
          }
          if (-not (Test-Path $basicSetup)) {
            throw "Basic installer not found: $basicSetup"
          }

          Get-Item $proSetup, $basicSetup | Select-Object Name, Length | Format-Table -AutoSize

          Copy-Item -Path $proSetup -Destination "artifacts/gist-$version-x64-setup-pro.exe" -Force
          Copy-Item -Path $basicSetup -Destination "artifacts/gist-$version-x64-setup-basic.exe" -Force

      - name: Commit version and push tag
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add package.json
          git commit --signoff -m "ci(release): bump version to ${{ steps.version.outputs.tag }} [skip ci]"

          git tag "${{ steps.version.outputs.tag }}"
          git push origin "HEAD:${{ github.ref_name }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          name: Release ${{ steps.version.outputs.tag }}
          tag: ${{ steps.version.outputs.tag }}
          draft: false
          prerelease: false
          generateReleaseNotes: true
          allowUpdates: true
          replacesArtifacts: true
          artifacts: 'artifacts/*.exe'
          token: ${{ secrets.GITHUB_TOKEN }}
